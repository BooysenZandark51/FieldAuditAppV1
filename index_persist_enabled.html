<!--
MIT License

Copyright (c) 2025 Gerhard Booysen

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Field Capture – Nama Khoi (App)</title>
    <style>
      :root { --bg:#0f172a; --panel:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;background:linear-gradient(180deg,#0b1222,#0f172a);color:var(--text);font:16px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial}
      .wrap{max-width:980px;margin:0 auto;padding:24px}
      .card{background:rgba(17,24,39,.9);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:20px;position:relative}
      h1{margin:0 0 12px;font-size:28px;letter-spacing:.2px}
      h2{margin:16px 0 8px;font-size:18px;color:#cbd5e1}
      label{display:block;margin:12px 0 6px;color:#cbd5e1}
      input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1020;color:var(--text);outline:none}
      input:focus,select:focus,textarea:focus{border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.15)}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
      .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
      button{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:600}
      .primary{background:var(--accent);color:#08110a}
      .muted{background:#374151;color:#e5e7eb}
      .pill{border:1px dashed rgba(255,255,255,.14);border-radius:12px;padding:8px 10px;font-size:12px;color:#94a3b8}
      .status{margin-top:12px;font-size:14px}
      .grid{display:grid;gap:14px}
      .footer{margin-top:12px;color:#94a3b8;font-size:12px}
      .kpi{display:flex;gap:12px;flex-wrap:wrap}
      .kpi div{background:#0b1020;border:1px solid rgba(255,255,255,.06);padding:10px 12px;border-radius:12px;color:#a1a1aa}
      .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);color:#cbd5e1}
      .hidden{display:none}
      .top-actions{position:absolute;top:16px;right:16px;display:flex;gap:8px}
      .iconbtn{background:#1f2937;color:#e5e7eb;border:1px solid rgba(255,255,255,.1);border-radius:9999px;padding:8px 10px;font-weight:700;cursor:pointer}
      .iconbtn:hover{filter:brightness(1.1)}
      .taglist{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
      .tag{display:flex;align-items:center;gap:6px;background:#0b1020;border:1px solid rgba(255,255,255,.12);border-radius:9999px;padding:6px 10px;color:#e5e7eb;font-size:13px}
      .tag button{background:transparent;border:0;color:#e5e7eb;cursor:pointer;padding:0 4px;font-size:14px}
      .banner{display:flex;align-items:center;justify-content:space-between;gap:12px;background:#0b1020;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;margin:12px 0;color:#cbd5e1}
      .banner .msg{font-size:14px}
      .banner button{background:#22c55e;color:#08110a;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
      .banner .muted{background:#374151;color:#e5e7eb}
      .danger{background:var(--danger);color:#fff}
      .warn{background:var(--warn);color:#111}
      .debug{margin-top:16px;border:1px dashed rgba(255,255,255,.2);padding:10px;border-radius:10px;color:#cbd5e1;font-size:13px}
      .tabs{display:flex;gap:8px;margin:10px 0}
      .tabbtn{background:#1f2937;color:#e5e7eb;border:1px solid rgba(255,255,255,.12)}
      .tabbtn.active{outline:2px solid #22c55e}
    </style>
  </head>
  <body>
    <div id="login" class="wrap">
      <div class="card" style="max-width:520px;margin:10vh auto">
        <h1>Sign in</h1>
        <form id="loginForm">
          <label for="loginUser">Username</label>
          <input id="loginUser" autocomplete="username" />
          <label for="loginPass">Password</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
          <div class="btns">
            <button class="primary" type="submit">Sign in</button>
          </div>
        </form>
      </div>
    </div>

    <div id="app" class="wrap hidden">
      <div class="card">
        <h1>Field Capture</h1>
        <div class="top-actions">
          <span id="currentUserBadge" class="badge">User: —</span>
          <button class="iconbtn" id="logoutBtn" title="Logout">↩︎</button>
          <button id="settingsBtn" class="iconbtn" title="Settings">⚙️</button>
        </div>
        <div class="tabs">
          <button id="tabCapture" class="tabbtn active" type="button">Capture</button>
          <button id="tabOutbox" class="tabbtn" type="button">Outbox</button>
        </div>
        <div class="kpi" id="kpis">
          <div><strong id="queuedCount">0</strong> in Outbox</div>
          <div><strong id="sentCount">0</strong> sent today</div>
          <div><span class="badge" id="tz">Africa/Johannesburg</span></div>
          <div><span class="badge" id="gps">GPS: —</span></div>
        </div>
        <div id="geoBanner" class="banner hidden">
          <span class="msg">This app needs your location for accurate audit records.</span>
          <div class="btns">
            <button id="geoBtn" type="button">Allow Location</button>
            <button id="geoRefreshBtn" class="muted" type="button">Refresh</button>
          </div>
        </div>
        <div class="pill" style="margin:12px 0">Set your n8n Webhook URL in Settings.</div>

        <div id="viewCapture">
          <div class="btns" id="outboxBtns">
            <button class="warn" id="syncBtn" type="button">Upload Outbox</button>
          </div>

          <form id="captureForm" class="grid" autocomplete="off">
            <h2>General</h2>
            <div class="row">
              <div>
                <label for="stand">Stand Nr *</label>
                <input id="stand" required />
              </div>
              <div>
                <label for="area">Area *</label>
                <select id="area" required>
                  <option value="">— Select area —</option>
                  <option>Springbok</option>
                  <option>Bergsig IND</option>
                  <option>Bergsig</option>
                  <option>Maaitjieskloof</option>
                  <option>Okiep</option>
                  <option>Concordia</option>
                  <option>Nababeep</option>
                  <option>Carolusberg</option>
                  <option>Fonteintjie</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="street">Street Address *</label>
                <input id="street" required />
              </div>
              <div>
                <label for="clientInfo">Client info complete?</label>
                <select id="clientInfo">
                  <option value="Outstanding">Outstanding</option>
                  <option value="Correct">Correct</option>
                  <option value="Dup correct Fixed">Dup correct Fixed</option>
                </select>
              </div>
            </div>

            <h2>Electrical</h2>
            <div class="row">
              <div>
                <label for="elecSn">Electrical Meter SN</label>
                <input id="elecSn" inputmode="numeric" />
              </div>
              <div>
                <label for="elecType">Meter Type</label>
                <select id="elecType">
                  <option value="">—</option>
                  <option>Actaris</option>
                  <option>Ampy</option>
                  <option>CBI</option>
                  <option>Econ</option>
                  <option>Enligt</option>
                  <option>Hexing</option>
                  <option>Ihemeter 3PH WC</option>
                  <option>Kamstrup 1PH</option>
                  <option>Kamstrup 3PH</option>
                  <option>L+G Cashpower</option>
                  <option>L+G E460</option>
                  <option>TSK/3</option>
                  <option>VC1800</option>
                  <option>VC3000</option>
                  <option>VC3100</option>
                  <option>Unknown</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="minisub">Minisub / Bulk</label>
                <input id="minisub" />
              </div>
              <div>
                <label for="feeder">Feeder (Feeds From)</label>
                <input id="feeder" />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="supplyCable">Supply Cable</label>
                <select id="supplyCable">
                  <option value="">—</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </div>
              <div>
                <label for="breakerState">Breaker State</label>
                <select id="breakerState">
                  <option value="">—</option>
                  <option>On</option>
                  <option>Off</option>
                </select>
              </div>
            </div>

            <h2>Water</h2>
            <div class="row">
              <div>
                <label for="waterSn">Water Meter SN</label>
                <input id="waterSn" inputmode="numeric" />
              </div>
              <div>
                <label for="waterType">Water Meter Type</label>
                <select id="waterType">
                  <option value="">—</option>
                </select>
              </div>
            </div>

            <div class="btns">
              <button class="primary" type="submit">Submit</button>
            </div>
            <div class="status" id="status"></div>
          </form>
        </div>

        <div id="viewOutbox" class="hidden">
          <h2>Outbox</h2>
          <div class="btns">
            <button class="warn" id="syncBtn2" type="button">Upload Outbox</button>
          </div>
          <table style="width:100%;border-collapse:collapse;margin-top:10px" id="outboxTable">
            <thead>
              <tr>
                <th style="text-align:left;border-bottom:1px solid #334155;padding:6px">#</th>
                <th style="text-align:left;border-bottom:1px solid #334155;padding:6px">Stand</th>
                <th style="text-align:left;border-bottom:1px solid #334155;padding:6px">Area</th>
                <th style="text-align:left;border-bottom:1px solid #334155;padding:6px">Street</th>
                <th style="text-align:left;border-bottom:1px solid #334155;padding:6px">Timestamp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="footer">All timestamps saved in Africa/Johannesburg (UTC+2).</div>
        <div id="debug" class="debug hidden"></div>
      </div>
    </div>

    <dialog id="settings">
      <form method="dialog" class="card" style="max-width:680px;width:90vw;margin:auto">
        <h2>Settings</h2>
        <label for="webhook">n8n Webhook URL *</label>
        <input id="webhook" placeholder="https://your-n8n/webhook/field-capture" required />
        <label for="team">Team Name</label>
        <input id="team" />

        <h3 style="margin-top:16px;color:#cbd5e1">Users</h3>
        <div id="usersList" class="taglist"></div>
        <div class="row">
          <div>
            <label for="newUser">New username</label>
            <input id="newUser" autocomplete="off" />
          </div>
          <div>
            <label for="newPass">New password</label>
            <input id="newPass" type="password" autocomplete="new-password" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="addUserBtn" class="muted" type="button">Add User</button>
          </div>
        </div>

        <h3 style="margin-top:16px;color:#cbd5e1">Electrical meter types</h3>
        <div class="taglist" id="elecTypesList"></div>
        <div class="row">
          <div>
            <label for="elecTypeNew">Add new type</label>
            <input id="elecTypeNew" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="addElecBtn" class="muted" type="button">Add</button>
          </div>
        </div>

        <h3 style="margin-top:10px;color:#cbd5e1">Water meter types</h3>
        <div class="taglist" id="waterTypesList"></div>
        <div class="row">
          <div>
            <label for="waterTypeNew">Add new type</label>
            <input id="waterTypeNew" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="addWaterBtn" class="muted" type="button">Add</button>
          </div>
        </div>

        <div class="btns">
          <button id="saveSettingsBtn" class="primary" value="default">Save</button>
          <button id="closeSettingsBtn" class="muted" value="cancel">Close</button>
        </div>
      </form>
    </dialog>

    <script type="module" src="user-store.js"></script>
<script type="module" src="capture-store.js"></script>
<script>
      (function(){
        'use strict';
        const LS = (function(){
  // Compatibility shim that routes important keys to the new stores.
  // Falls back to localStorage for anything unknown.
  const raw = {
    get(k){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):null }catch(e){ return null } },
    set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch(e){} },
    del(k){ try{ localStorage.removeItem(k) }catch(e){} },
  };
  function isOutbox(k){ return /(^guest:outbox$)|(^outbox@)/.test(k) }
  function isDraft(k){ return /(^guest:draft$)|(^draft@)/.test(k) }
  function isGPS(k){ return /(^guest:lastGPS$)|(^lastGPS@)/.test(k) }
  function isSentLog(k){ return /(^guest:sentLog$)|(^sentLog@)/.test(k) }

  return {
    get(k){
      if (k==='settings') return (window.UserStore?UserStore.getSettings():raw.get(k));
      if (k==='currentUser') return (window.UserStore?UserStore.getCurrentUser():raw.get(k));
      if (isOutbox(k)) return (window.CaptureStore?CaptureStore.getOutbox():raw.get(k));
      if (isDraft(k)) return (window.CaptureStore?CaptureStore.loadDraft():raw.get(k));
      if (isGPS(k)) return (window.CaptureStore?CaptureStore.getGPS():raw.get(k));
      // For sentLog we keep using raw store to avoid changing app expectations
      if (isSentLog(k)) return raw.get(k) || {};
      return raw.get(k);
    },
    set(k,v){
      if (k==='settings') return (window.UserStore?UserStore.saveSettings(v):raw.set(k,v));
      if (k==='currentUser') return raw.set(k,v); // currentUser is managed by UserStore.login/logout; keep raw for compatibility
      if (isOutbox(k)) return (window.CaptureStore? (function(){ /* rewrite whole outbox */ 
          // Clear then requeue to mirror previous behaviour
          localStorage.setItem(k, JSON.stringify(v)); 
        })() : raw.set(k,v));
      if (isDraft(k)) return (window.CaptureStore?CaptureStore.saveDraft(v):raw.set(k,v));
      if (isGPS(k)) return (window.CaptureStore?CaptureStore.setGPS(v):raw.set(k,v));
      if (isSentLog(k)) return raw.set(k,v);
      return raw.set(k,v);
    },
    del(k){
      if (k==='settings'){ localStorage.removeItem(k); return }
      if (k==='currentUser'){ localStorage.removeItem(k); return }
      if (isOutbox(k)){ return (window.CaptureStore?CaptureStore.clearOutbox():raw.del(k)) }
      if (isDraft(k)){ return (window.CaptureStore?CaptureStore.clearDraft():raw.del(k)) }
      if (isGPS(k)){ return raw.del(k) }
      if (isSentLog(k)){ return raw.del(k) }
      return raw.del(k);
    }
  };
})();
        const tz='Africa/Johannesburg';
        const defaultElecTypes=['Actaris','Ampy','CBI','Econ','Enligt','Hexing','Ihemeter 3PH WC','Kamstrup 1PH','Kamstrup 3PH','L+G Cashpower','L+G E460','TSK/3','VC1800','VC3000','VC3100','Unknown'];
        const defaultWaterTypes=['Lesira','Kent','Sensus','Elster'];
        function getCurrentUser(){return LS.get('currentUser')}
        function userKey(k){const u=getCurrentUser();return(u&&u.u)?(k+'@'+u.u):('guest:'+k)}
        function fmt(n){return(n||0).toLocaleString('en-ZA')}

        function ensureSettings(){const s=LS.get('settings')||{}; if(!Array.isArray(s.elecTypes)) s.elecTypes=[...defaultElecTypes]; else { const merged=[...new Set([...s.elecTypes,...defaultElecTypes])]; const i=merged.indexOf('Unknown'); if(i>-1)merged.splice(i,1); merged.sort((a,b)=>a.localeCompare(b)); merged.push('Unknown'); s.elecTypes=merged } if(!Array.isArray(s.waterTypes)) s.waterTypes=[...defaultWaterTypes]; if(!Array.isArray(s.users)) s.users=[{u:'Gerhard.B',p:'Gt55115511'}]; LS.set('settings',s); return s }

        function refreshKpis(){const out=LS.get(userKey('outbox'))||[]; const qc=document.getElementById('queuedCount'); if(qc)qc.textContent=fmt(out.length); const today=new Date().toLocaleDateString('en-CA',{timeZone:tz}); const sentLog=LS.get(userKey('sentLog'))||{}; const sc=document.getElementById('sentCount'); if(sc)sc.textContent=fmt(sentLog[today]||0); const tab=document.getElementById('tabOutbox'); if(tab)tab.textContent='Outbox ('+out.length+')'}

        function renderOutbox(){const tb=document.querySelector('#outboxTable tbody'); if(!tb)return; tb.innerHTML=''; const out=LS.get(userKey('outbox'))||[]; out.forEach((it,i)=>{ const tr=document.createElement('tr'); const ts=it&&it.meta&&it.meta.submitted_at?new Date(it.meta.submitted_at).toLocaleString():'—'; const stand=it?.record?.stand||''; const area=it?.record?.area||''; const street=it?.record?.street||''; tr.innerHTML='<td style="padding:6px;border-bottom:1px solid #334155">'+(i+1)+'</td><td style="padding:6px;border-bottom:1px solid #334155">'+stand+'</td><td style="padding:6px;border-bottom:1px solid #334155">'+area+'</td><td style="padding:6px;border-bottom:1px solid #334155">'+street+'</td><td style="padding:6px;border-bottom:1px solid #334155">'+ts+'</td>'; tb.appendChild(tr) })}

        function switchTab(which){const cap=document.getElementById('viewCapture'); const out=document.getElementById('viewOutbox'); const b1=document.getElementById('tabCapture'); const b2=document.getElementById('tabOutbox'); if(which==='outbox'){cap?.classList.add('hidden'); out?.classList.remove('hidden'); b1?.classList.remove('active'); b2?.classList.add('active'); renderOutbox()} else {out?.classList.add('hidden'); cap?.classList.remove('hidden'); b2?.classList.remove('active'); b1?.classList.add('active')}}

        function updateBadge(lat,lon,acc){const el=document.getElementById('gps'); if(!el)return; el.textContent='GPS: '+lat.toFixed(6)+', '+lon.toFixed(6)+' (±'+Math.round(acc)+' m)'}
        function oneShotLocation(){ if(!('geolocation' in navigator))return; navigator.geolocation.getCurrentPosition(pos=>{ const {latitude,longitude,accuracy}=pos.coords; updateBadge(latitude,longitude,accuracy); LS.set(userKey('lastGPS'),{latitude,longitude,accuracy,ts:new Date().toISOString()}) },()=>{}, {enableHighAccuracy:true,timeout:8000,maximumAge:0}) }
        function startGeoWatch(){ const gpsEl=document.getElementById('gps'); if(!('geolocation' in navigator)){ gpsEl&&(gpsEl.textContent='GPS: unavailable'); return } gpsEl&&(gpsEl.textContent='GPS: locating…'); navigator.geolocation.watchPosition(pos=>{ const {latitude,longitude,accuracy}=pos.coords; updateBadge(latitude,longitude,accuracy); LS.set(userKey('lastGPS'),{latitude,longitude,accuracy,ts:new Date().toISOString()}) },()=>{}, {enableHighAccuracy:true,maximumAge:5000,timeout:10000}) }
        function initGeoPermissions(){ if(!('geolocation' in navigator)){ const el=document.getElementById('gps'); el&&(el.textContent='GPS: unavailable'); return } startGeoWatch() }

        function populateTypes(){ const s=ensureSettings(); const e=document.getElementById('elecType'); const w=document.getElementById('waterType'); function set(sel,arr){ if(!sel)return; const cur=sel.value; sel.innerHTML=''; const o=document.createElement('option'); o.value=''; o.textContent='—'; sel.appendChild(o); arr.forEach(t=>{ const opt=document.createElement('option'); opt.textContent=t; sel.appendChild(opt) }); const other=document.createElement('option'); other.textContent='Other'; sel.appendChild(other); let found=false; for(let i=0;i<sel.options.length;i++){ if(sel.options[i].textContent===cur){ found=true; break } } sel.value=found?cur:'' } set(e,s.elecTypes); set(w,s.waterTypes) }

        function queuePayload(p){ const out=LS.get(userKey('outbox'))||[]; out.push(p); LS.set(userKey('outbox'),out); refreshKpis(); renderOutbox() }
        async function sendToWebhook(body,url){ try{ const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); return {ok:res.ok} }catch(e){ return {ok:false} } }
        async function syncOutbox(opts){ opts=opts||{silent:false}; const s=LS.get('settings')||{}; if(!s.webhook){ if(!opts.silent)alert('Set your webhook in Settings'); return } let out=LS.get(userKey('outbox'))||[]; if(out.length===0){ if(!opts.silent)alert('Nothing to sync'); return } const delayMs=2000; let sent=0; const finalize=(hadFail)=>{ if(!opts.silent){ const remaining=(LS.get(userKey('outbox'))||[]).length; let msg='Synced '+sent+' item(s)'; msg+= hadFail ? '; stopped on an error. Remaining: '+remaining : '; done.'; alert(msg) } }; const processNext=async()=>{ out=LS.get(userKey('outbox'))||[]; if(out.length===0){ finalize(false); return } const item=out[0]; const r=await sendToWebhook(item,s.webhook); if(r&&r.ok){ out.shift(); LS.set(userKey('outbox'),out); const today=new Date().toLocaleDateString('en-CA',{timeZone:tz}); const log=LS.get(userKey('sentLog'))||{}; log[today]=(log[today]||0)+1; LS.set(userKey('sentLog'),log); sent++; refreshKpis(); renderOutbox(); setTimeout(processNext,delayMs) } else { finalize(true) } }; processNext() }

        function wipeOutbox(){ let size=0; try{ const raw=localStorage.getItem(userKey('outbox')); if(raw){ const arr=JSON.parse(raw); size=Array.isArray(arr)?arr.length:1 } }catch(e){ size=1 } if(size===0){ alert('Outbox is already empty'); return } if(confirm('Clear all queued items?')){ localStorage.removeItem(userKey('outbox')); refreshKpis(); renderOutbox(); alert('Outbox cleared') } }

        const FIELD_IDS=['stand','area','street','clientInfo','elecSn','elecType','minisub','feeder','supplyCable','breakerState','waterSn','waterType'];
        function gather(){ const d={}; FIELD_IDS.forEach(id=>{ const el=document.getElementById(id); if(el)d[id]=el.value }); d._ts=new Date().toISOString(); return d }
        function applyDraft(d){ if(!d)return; FIELD_IDS.forEach(id=>{ if(d[id]!==undefined){ const el=document.getElementById(id); if(el)el.value=d[id] } }) }
        function saveDraft(){ LS.set(userKey('draft'),gather()) }
        function loadDraft(){ const d=LS.get(userKey('draft')); if(d)applyDraft(d) }
        function resetForm(){ const form=document.getElementById('captureForm'); if(form)form.reset(); LS.del(userKey('draft')); populateTypes(); ['area','elecType','supplyCable','breakerState','waterType'].forEach(id=>{ const el=document.getElementById(id); if(el)el.value='' }); const s=document.getElementById('status'); if(s)s.textContent=''; const first=document.getElementById('stand'); first&&first.focus() }
        function val(id){ const el=document.getElementById(id); return (el&&el.value?el.value:'').trim() }

        async function onSubmit(e){ e.preventDefault(); const s=LS.get('settings')||{}; const gps=LS.get(userKey('lastGPS')); const cur=getCurrentUser(); const payload={ meta:{ version:1, submitted_at:new Date().toISOString(), timezone:tz, team:s.team||null, ua:navigator.userAgent, user: cur&&cur.u?cur.u:null }, record:{ stand:val('stand'), area:val('area'), street:val('street'), client_info:val('clientInfo'), electrical:{ sn:val('elecSn'), type:val('elecType'), minisub:val('minisub'), feeder:val('feeder'), supply_cable:val('supplyCable'), breaker_state:val('breakerState') }, water:{ sn:val('waterSn'), type:val('waterType') }, gps:gps||null } }; if(!payload.record.stand||!payload.record.area||!payload.record.street){ alert('Please fill Stand, Area and Street'); return } if(!s.webhook){ queuePayload(payload); resetForm(); alert('No webhook set – queued to Outbox'); return } const r=await sendToWebhook(payload,s.webhook); if(r&&r.ok){ const today=new Date().toLocaleDateString('en-CA',{timeZone:tz}); const log=LS.get(userKey('sentLog'))||{}; log[today]=(log[today]||0)+1; LS.set(userKey('sentLog'),log); refreshKpis(); resetForm(); alert('Submitted ✔') } else { queuePayload(payload); resetForm(); alert('Offline or server error – queued to Outbox') } }

        function renderUsers(){ const s=ensureSettings(); const box=document.getElementById('usersList'); if(!box)return; box.innerHTML=''; s.users.forEach((u,i)=>{ const tag=document.createElement('span'); tag.className='tag'; const name=document.createElement('span'); name.textContent=u.u; const btn=document.createElement('button'); btn.type='button'; btn.textContent='✕'; btn.dataset.delUser=String(i); tag.appendChild(name); tag.appendChild(btn); box.appendChild(tag) }) }
        function addUser(){ const user=(document.getElementById('newUser').value||'').trim(); const pass=(document.getElementById('newPass').value||'').trim(); if(!user||!pass){ alert('Enter username and password'); return } const s=ensureSettings(); if(s.users.some(x=>x.u===user)){ alert('User already exists'); return } s.users.push({u:user,p:pass}); LS.set('settings',s); document.getElementById('newUser').value=''; document.getElementById('newPass').value=''; renderUsers() }
        function delUser(i){ const s=ensureSettings(); if(s.users.length<=1){ alert('Cannot delete the last user'); return } const cur=LS.get('currentUser'); const uname=s.users[i]?.u; if(cur&&cur.u===uname){ alert('Log out before deleting this user'); return } if(!confirm('Delete user '+uname+'?'))return; s.users.splice(i,1); LS.set('settings',s); renderUsers() }

        function loadSettings(){ const s=ensureSettings(); const wh=document.getElementById('webhook'); const team=document.getElementById('team'); if(wh)wh.value=s.webhook||''; if(team)team.value=s.team||'' }
        function saveSettings(){ const wh=(document.getElementById('webhook')?.value||'').trim(); const team=(document.getElementById('team')?.value||'').trim(); if(!/^https?:\/\//i.test(wh)){ alert('Please enter a valid webhook URL'); return } const s=ensureSettings(); s.webhook=wh; s.team=team; LS.set('settings',s); const dlg=document.getElementById('settings'); dlg?.close?.(); alert('Settings saved'); populateTypes() }
        function openSettings(){ const cur=LS.get('currentUser'); if(!cur||cur.u!=='Gerhard.B'){ alert('Only Gerhard.B can open Settings'); return } const dlg=document.getElementById('settings'); if(dlg&&typeof dlg.showModal==='function'){ dlg.showModal() } else if(dlg){ dlg.setAttribute('open','') } loadSettings(); renderUsers(); renderTypeLists() }

        function renderTypeLists(){ const s=ensureSettings(); const el=document.getElementById('elecTypesList'); const wl=document.getElementById('waterTypesList'); if(el){ el.innerHTML=''; s.elecTypes.forEach((t,i)=>{ const tag=document.createElement('span'); tag.className='tag'; tag.innerHTML=t+' <button type="button" data-del-elec="'+i+'">✕</button>'; el.appendChild(tag) }) } if(wl){ wl.innerHTML=''; s.waterTypes.forEach((t,i)=>{ const tag=document.createElement('span'); tag.className='tag'; tag.innerHTML=t+' <button type="button" data-del-water="'+i+'">✕</button>'; wl.appendChild(tag) }) } }
        function addElecType(){ const v=(document.getElementById('elecTypeNew').value||'').trim(); if(!v)return; const s=ensureSettings(); if(!s.elecTypes.includes(v)){ if(v!=='Unknown'){ s.elecTypes.splice(s.elecTypes.length-1,0,v); s.elecTypes=[...new Set(s.elecTypes.filter(x=>x!=='Unknown'))].sort((a,b)=>a.localeCompare(b)); s.elecTypes.push('Unknown') } } LS.set('settings',s); document.getElementById('elecTypeNew').value=''; renderTypeLists(); populateTypes() }
        function delElecType(i){ const s=ensureSettings(); s.elecTypes.splice(i,1); if(!s.elecTypes.includes('Unknown'))s.elecTypes.push('Unknown'); s.elecTypes=[...new Set(s.elecTypes.filter(x=>x!=='Unknown'))].sort((a,b)=>a.localeCompare(b)); s.elecTypes.push('Unknown'); LS.set('settings',s); renderTypeLists(); populateTypes() }
        function addWaterType(){ const v=(document.getElementById('waterTypeNew').value||'').trim(); if(!v)return; const s=ensureSettings(); if(!s.waterTypes.includes(v))s.waterTypes.push(v); LS.set('settings',s); document.getElementById('waterTypeNew').value=''; renderTypeLists(); populateTypes() }
        function delWaterType(i){ const s=ensureSettings(); s.waterTypes.splice(i,1); LS.set('settings',s); renderTypeLists(); populateTypes() }

        function setAuthUI(){ const cur=LS.get('currentUser'); const app=document.getElementById('app'); const login=document.getElementById('login'); const badge=document.getElementById('currentUserBadge'); const settingsBtn=document.getElementById('settingsBtn'); if(cur&&cur.u){ badge&&(badge.textContent='User: '+cur.u); app?.classList.remove('hidden'); login?.classList.add('hidden'); if(settingsBtn){ if(cur.u==='Gerhard.B') settingsBtn.classList.remove('hidden'); else settingsBtn.classList.add('hidden') } refreshKpis(); populateTypes(); loadDraft(); initGeoPermissions(); const g=LS.get(userKey('lastGPS')); if(g){ updateBadge(g.latitude,g.longitude,g.accuracy) } } else { badge&&(badge.textContent='User: —'); app?.classList.add('hidden'); login?.classList.remove('hidden'); settingsBtn?.classList.add('hidden') } }
        function performLogin(e){ e?.preventDefault?.(); const u=(document.getElementById('loginUser').value||'').trim(); const p=(document.getElementById('loginPass').value||'').trim(); const s=ensureSettings(); const ok=s.users.some(it=>it.u===u&&it.p===p); if(ok){ LS.set('currentUser',{u}); setAuthUI() } else { alert('Invalid username or password') } }
        function logout(){ LS.del('currentUser'); try{ const form=document.getElementById('captureForm'); form?.reset(); ['area','elecType','supplyCable','breakerState','waterType'].forEach(id=>{ const el=document.getElementById(id); if(el)el.value='' }) }catch(e){} setAuthUI() }

        document.addEventListener('DOMContentLoaded',()=>{
          document.getElementById('tz').textContent=tz;
          document.getElementById('tabCapture').addEventListener('click',()=>switchTab('capture'));
          document.getElementById('tabOutbox').addEventListener('click',()=>switchTab('outbox'));
          document.getElementById('loginForm').addEventListener('submit',performLogin);
          document.getElementById('logoutBtn').addEventListener('click',logout);
          document.getElementById('settingsBtn').addEventListener('click',openSettings);
          document.getElementById('geoBtn').addEventListener('click',oneShotLocation);
          document.getElementById('geoRefreshBtn').addEventListener('click',oneShotLocation);
          document.getElementById('captureForm').addEventListener('submit',onSubmit);
          document.getElementById('syncBtn').addEventListener('click',()=>syncOutbox());
          document.getElementById('syncBtn2').addEventListener('click',()=>syncOutbox());
          document.getElementById('addUserBtn').addEventListener('click',addUser);
          document.getElementById('addElecBtn').addEventListener('click',addElecType);
          document.getElementById('addWaterBtn').addEventListener('click',addWaterType);
          document.getElementById('usersList').addEventListener('click',e=>{ const t=e.target; if(t?.dataset?.delUser){ delUser(parseInt(t.dataset.delUser,10)) } });
          document.getElementById('elecTypesList').addEventListener('click',e=>{ const t=e.target; const idx=t?.getAttribute('data-del-elec'); if(idx!=null){ delElecType(parseInt(idx,10)) } });
          document.getElementById('waterTypesList').addEventListener('click',e=>{ const t=e.target; const idx=t?.getAttribute('data-del-water'); if(idx!=null){ delWaterType(parseInt(idx,10)) } });
          document.getElementById('saveSettingsBtn').addEventListener('click',e=>{ e.preventDefault(); saveSettings() });
          document.getElementById('closeSettingsBtn').addEventListener('click',()=>{ const dlg=document.getElementById('settings'); dlg?.close?.() });
          setInterval(()=>{ const s=LS.get('settings')||{}; const out=LS.get(userKey('outbox'))||[]; if(s.webhook&&out.length>0){ syncOutbox({silent:true}) } },180000);
          document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible'){ const s=LS.get('settings')||{}; const out=LS.get(userKey('outbox'))||[]; if(s.webhook&&out.length>0){ syncOutbox({silent:true}) } } });
          setAuthUI();
        });
      })();
    </script>
  </body>
</html>
